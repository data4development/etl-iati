<?xml version="1.0" encoding="UTF-8"?>
<!--
ETL-IATI: processing IATI data with Apache Hop
Copyright (C) 2018-2021, Rolf Kleef (drostan.org and data4development.org)

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<pipeline>
  <info>
    <name>store-transactions</name>
    <name_sync_with_filename>Y</name_sync_with_filename>
    <description/>
    <extended_description/>
    <pipeline_version/>
    <pipeline_type>Normal</pipeline_type>
    <parameters>
    </parameters>
    <capture_transform_performance>N</capture_transform_performance>
    <transform_performance_capturing_delay>1000</transform_performance_capturing_delay>
    <transform_performance_capturing_size_limit>100</transform_performance_capturing_size_limit>
    <created_user>-</created_user>
    <created_date>2018/07/11 12:05:58.166</created_date>
    <modified_user>-</modified_user>
    <modified_date>2020/02/11 17:31:13.189</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
  </notepads>
  <order>
    <hop>
      <from>Get transactions</from>
      <to>Replace nulls with transaction defaults</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Mapping input specification</from>
      <to>Get transactions</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Convert value to EUR</from>
      <to>Determine transaction-typed value</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Replace nulls with transaction defaults</from>
      <to>Add target-currency EUR</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Add target-currency EUR</from>
      <to>Convert value to EUR</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Insert  Transaction</from>
      <to>Mapping output specification</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Determine transaction-typed value</from>
      <to>Lookup date</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Lookup date</from>
      <to>Lookup value-date</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Lookup value-date</from>
      <to>Insert  Transaction</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <transform>
    <name>Add target-currency EUR</name>
    <type>Constant</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <set_empty_string>N</set_empty_string>
        <length>-1</length>
        <name>target-currency</name>
        <precision>-1</precision>
        <type>String</type>
        <nullif>EUR</nullif>
      </field>
    </fields>
    <attributes/>
    <GUI>
      <xloc>352</xloc>
      <yloc>320</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Convert value to EUR</name>
    <type>SimpleMapping</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <filename>${PROJECT_HOME}/partnership_dashboard/lib/currency-convert-to-EUR.hpl</filename>
    <mappings>
      <input>
        <mapping>
          <input_transform/>
          <output_transform/>
          <main_path>Y</main_path>
          <rename_on_output>Y</rename_on_output>
          <description/>
          <connector>
            <parent>value</parent>
            <child>value</child>
          </connector>
          <connector>
            <parent>value-date</parent>
            <child>value-date</child>
          </connector>
          <connector>
            <parent>currency</parent>
            <child>currency</child>
          </connector>
          <connector>
            <parent>target-currency</parent>
            <child>target-currency</child>
          </connector>
        </mapping>
      </input>
      <output>
        <mapping>
          <input_transform/>
          <output_transform/>
          <main_path>Y</main_path>
          <rename_on_output>N</rename_on_output>
          <description/>
        </mapping>
      </output>
      <parameters>
        <inherit_all_vars>Y</inherit_all_vars>
      </parameters>
    </mappings>
    <attributes/>
    <GUI>
      <xloc>528</xloc>
      <yloc>320</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Determine transaction-typed value</name>
    <type>ScriptValueMod</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <optimizationLevel>9</optimizationLevel>
    <jsScripts>
      <jsScript>
        <jsScript_type>0</jsScript_type>
        <jsScript_name>Script 1</jsScript_name>
        <jsScript_script>incoming_funds = 0;
disbursement = 0;
expenditure = 0;
incoming_commitment = 0;
outgoing_commitment = 0;

if (transaction_type == "1") {
	incoming_funds = value
}
if (transaction_type == "2") {
	outgoing_commitment = value
}
if (transaction_type == "3") {
	disbursement = value
}
if (transaction_type == "4") {
	expenditure = value
}
if (transaction_type == "11") {
	incoming_commitment = value
}
</jsScript_script>
      </jsScript>
    </jsScripts>
    <fields>
      <field>
        <name>incoming_funds</name>
        <rename>incoming_funds</rename>
        <type>Number</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>disbursement</name>
        <rename>disbursement</rename>
        <type>Number</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>expenditure</name>
        <rename>expenditure</rename>
        <type>Number</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>incoming_commitment</name>
        <rename>incoming_commitment</rename>
        <type>Number</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>outgoing_commitment</name>
        <rename>outgoing_commitment</rename>
        <type>Number</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
    </fields>
    <attributes/>
    <GUI>
      <xloc>144</xloc>
      <yloc>448</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Get transactions</name>
    <type>getXMLData</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <include>N</include>
    <include_field/>
    <rownum>N</rownum>
    <addresultfile>N</addresultfile>
    <namespaceaware>N</namespaceaware>
    <ignorecomments>N</ignorecomments>
    <readurl>N</readurl>
    <validating>N</validating>
    <usetoken>N</usetoken>
    <IsIgnoreEmptyFile>N</IsIgnoreEmptyFile>
    <doNotFailIfNoFile>Y</doNotFailIfNoFile>
    <rownum_field/>
    <encoding>UTF-8</encoding>
    <file>
      <name/>
      <filemask/>
      <exclude_filemask/>
      <file_required>N</file_required>
      <include_subfolders>N</include_subfolders>
    </file>
    <fields>
      <field>
        <name>transaction_type</name>
        <xpath>transaction-type/@code</xpath>
        <element_type>attribut</element_type>
        <result_type>valueof</result_type>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
        <repeat>N</repeat>
      </field>
      <field>
        <name>transaction-date</name>
        <xpath>transaction-date/@iso-date</xpath>
        <element_type>attribut</element_type>
        <result_type>valueof</result_type>
        <type>Date</type>
        <format>yyyy-MM-dd</format>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
        <repeat>N</repeat>
      </field>
      <field>
        <name>value</name>
        <xpath>value</xpath>
        <element_type>node</element_type>
        <result_type>valueof</result_type>
        <type>Number</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
        <repeat>N</repeat>
      </field>
      <field>
        <name>value-date</name>
        <xpath>value/@value-date|transaction-date/@iso-date</xpath>
        <element_type>attribut</element_type>
        <result_type>valueof</result_type>
        <type>Date</type>
        <format>yyyy-MM-dd</format>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
        <repeat>N</repeat>
      </field>
      <field>
        <name>currency</name>
        <xpath>value/@currency|../@default-currency</xpath>
        <element_type>attribut</element_type>
        <result_type>valueof</result_type>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
        <repeat>N</repeat>
      </field>
      <field>
        <name>provider-activity-identifier</name>
        <xpath>provider-org/@provider-activity-id</xpath>
        <element_type>attribut</element_type>
        <result_type>valueof</result_type>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
        <repeat>N</repeat>
      </field>
      <field>
        <name>provider-identifier</name>
        <xpath>provider-org/@ref</xpath>
        <element_type>attribut</element_type>
        <result_type>valueof</result_type>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
        <repeat>N</repeat>
      </field>
      <field>
        <name>provider-type</name>
        <xpath>provider-org/@type</xpath>
        <element_type>attribut</element_type>
        <result_type>valueof</result_type>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
        <repeat>N</repeat>
      </field>
      <field>
        <name>receiver-activity-identifier</name>
        <xpath>receiver-org/@receiver-activity-id</xpath>
        <element_type>attribut</element_type>
        <result_type>valueof</result_type>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
        <repeat>N</repeat>
      </field>
      <field>
        <name>receiver-identifier</name>
        <xpath>receiver-org/@ref</xpath>
        <element_type>attribut</element_type>
        <result_type>valueof</result_type>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
        <repeat>N</repeat>
      </field>
      <field>
        <name>receiver-type</name>
        <xpath>receiver-org/@type</xpath>
        <element_type>attribut</element_type>
        <result_type>valueof</result_type>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
        <repeat>N</repeat>
      </field>
    </fields>
    <limit>0</limit>
    <loopxpath>iati-activity/transaction</loopxpath>
    <IsInFields>Y</IsInFields>
    <IsAFile>N</IsAFile>
    <XmlField>activity-xml</XmlField>
    <prunePath/>
    <shortFileFieldName/>
    <pathFieldName/>
    <hiddenFieldName/>
    <lastModificationTimeFieldName/>
    <uriNameFieldName/>
    <rootUriNameFieldName/>
    <extensionFieldName/>
    <sizeFieldName/>
    <attributes/>
    <GUI>
      <xloc>352</xloc>
      <yloc>208</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Insert  Transaction</name>
    <type>TableOutput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <commit>1000</commit>
    <connection>dataworkbench</connection>
    <fields>
      <field>
        <column_name>activity-identifier</column_name>
        <stream_name>activity-identifier</stream_name>
      </field>
      <field>
        <column_name>organisation-id</column_name>
        <stream_name>organisation-id</stream_name>
      </field>
      <field>
        <column_name>activity-id</column_name>
        <stream_name>activity-id</stream_name>
      </field>
      <field>
        <column_name>type</column_name>
        <stream_name>transaction_type</stream_name>
      </field>
      <field>
        <column_name>date</column_name>
        <stream_name>date</stream_name>
      </field>
      <field>
        <column_name>value</column_name>
        <stream_name>value_eur</stream_name>
      </field>
      <field>
        <column_name>value-date</column_name>
        <stream_name>value_date</stream_name>
      </field>
      <field>
        <column_name>currency</column_name>
        <stream_name>currency</stream_name>
      </field>
      <field>
        <column_name>incoming-funds</column_name>
        <stream_name>incoming_funds</stream_name>
      </field>
      <field>
        <column_name>disbursement</column_name>
        <stream_name>disbursement</stream_name>
      </field>
      <field>
        <column_name>expenditure</column_name>
        <stream_name>expenditure</stream_name>
      </field>
      <field>
        <column_name>incoming-commitment</column_name>
        <stream_name>incoming_commitment</stream_name>
      </field>
      <field>
        <column_name>outgoing-commitment</column_name>
        <stream_name>outgoing_commitment</stream_name>
      </field>
    </fields>
    <ignore_errors>N</ignore_errors>
    <partitioning_daily>N</partitioning_daily>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_monthly>Y</partitioning_monthly>
    <return_keys>N</return_keys>
    <schema>dra</schema>
    <specify_fields>Y</specify_fields>
    <table>fct_transactions</table>
    <tablename_in_field>N</tablename_in_field>
    <tablename_in_table>Y</tablename_in_table>
    <truncate>N</truncate>
    <use_batch>Y</use_batch>
    <attributes/>
    <GUI>
      <xloc>352</xloc>
      <yloc>576</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Lookup date</name>
    <type>DBLookup</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <cache_size>0</cache_size>
    <cache>N</cache>
    <connection>dataworkbench</connection>
    <cache_load_all>N</cache_load_all>
    <lookup>
      <eat_row_on_failure>N</eat_row_on_failure>
      <fail_on_multiple>N</fail_on_multiple>
      <key>
        <condition>=</condition>
        <name>transaction-date</name>
        <field>date_id</field>
      </key>
      <value>
        <type>Date</type>
        <default>1970/01/01 00:00:00.000</default>
        <rename>date</rename>
        <name>date_id</name>
      </value>
      <schema>dra</schema>
      <table>dim_date</table>
    </lookup>
    <attributes/>
    <GUI>
      <xloc>352</xloc>
      <yloc>448</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Lookup value-date</name>
    <type>DBLookup</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <cache_size>0</cache_size>
    <cache>N</cache>
    <connection>dataworkbench</connection>
    <cache_load_all>N</cache_load_all>
    <lookup>
      <eat_row_on_failure>N</eat_row_on_failure>
      <fail_on_multiple>N</fail_on_multiple>
      <key>
        <condition>=</condition>
        <name>value-date</name>
        <field>date_id</field>
      </key>
      <value>
        <type>Date</type>
        <default>1970/01/01 00:00:00.000</default>
        <rename>value_date</rename>
        <name>date_id</name>
      </value>
      <schema>dra</schema>
      <table>dim_date</table>
    </lookup>
    <attributes/>
    <GUI>
      <xloc>528</xloc>
      <yloc>448</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Mapping input specification</name>
    <type>MappingInput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <name>activity-identifier</name>
        <type>String</type>
        <length>-1</length>
        <precision>-1</precision>
      </field>
      <field>
        <name>activity-xml</name>
        <type>String</type>
        <length>-1</length>
        <precision>-1</precision>
      </field>
      <field>
        <name>organisation-id</name>
        <type>Integer</type>
        <length>9</length>
        <precision>0</precision>
      </field>
      <field>
        <name>activity-id</name>
        <type>Integer</type>
        <length>9</length>
        <precision>0</precision>
      </field>
    </fields>
    <attributes/>
    <GUI>
      <xloc>144</xloc>
      <yloc>208</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Mapping output specification</name>
    <type>MappingOutput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <attributes/>
    <GUI>
      <xloc>528</xloc>
      <yloc>576</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Replace nulls with transaction defaults</name>
    <type>IfNull</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <replaceAllByValue/>
    <replaceAllMask/>
    <selectFields>Y</selectFields>
    <selectValuesType>N</selectValuesType>
    <setEmptyStringAll>N</setEmptyStringAll>
    <valuetypes>
      </valuetypes>
    <fields>
      <field>
        <name>transaction_type</name>
        <value>N/A</value>
        <mask/>
        <set_empty_string>N</set_empty_string>
      </field>
      <field>
        <name>provider-activity-identifier</name>
        <value>N/A</value>
        <mask/>
        <set_empty_string>N</set_empty_string>
      </field>
      <field>
        <name>provider-identifier</name>
        <value>N/A</value>
        <mask/>
        <set_empty_string>N</set_empty_string>
      </field>
      <field>
        <name>provider-type</name>
        <value>N/A</value>
        <mask/>
        <set_empty_string>N</set_empty_string>
      </field>
      <field>
        <name>receiver-activity-identifier</name>
        <value>N/A</value>
        <mask/>
        <set_empty_string>N</set_empty_string>
      </field>
      <field>
        <name>receiver-identifier</name>
        <value>N/A</value>
        <mask/>
        <set_empty_string>N</set_empty_string>
      </field>
      <field>
        <name>receiver-type</name>
        <value>N/A</value>
        <mask/>
        <set_empty_string>N</set_empty_string>
      </field>
    </fields>
    <attributes/>
    <GUI>
      <xloc>144</xloc>
      <yloc>320</yloc>
    </GUI>
  </transform>
  <transform_error_handling>
  </transform_error_handling>
  <attributes/>
</pipeline>
