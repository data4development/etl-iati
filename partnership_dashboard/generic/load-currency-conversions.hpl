<pipeline>
  <info>
    <name>load-currency-conversions</name>
    <name_sync_with_filename>Y</name_sync_with_filename>
    <description/>
    <extended_description/>
    <pipeline_version/>
    <pipeline_type>Normal</pipeline_type>
    <directory>/partnership_dashboard/generic</directory>
    <parameters>
    </parameters>
    <capture_transform_performance>N</capture_transform_performance>
    <transform_performance_capturing_delay>1000</transform_performance_capturing_delay>
    <transform_performance_capturing_size_limit>100</transform_performance_capturing_size_limit>
    <created_user>-</created_user>
    <created_date>2018/12/05 14:51:20.242</created_date>
    <modified_user>-</modified_user>
    <modified_date>2018/12/06 11:20:16.107</modified_date>
    <key_for_session_key/>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
    <notepad>
      <note>To do:
- add variable for location currency rates files
- add metadata injection to only process "recent files"
  (expecting the transformation to run almost daily)
- add further logic to do additional calculations: to_euro rate etc</note>
      <xloc>48</xloc>
      <yloc>160</yloc>
      <width>379</width>
      <heigth>105</heigth>
      <fontname>Alegreya Sans</fontname>
      <fontsize>11</fontsize>
      <fontbold>N</fontbold>
      <fontitalic>N</fontitalic>
      <fontcolorred>0</fontcolorred>
      <fontcolorgreen>0</fontcolorgreen>
      <fontcolorblue>0</fontcolorblue>
      <backgroundcolorred>255</backgroundcolorred>
      <backgroundcolorgreen>205</backgroundcolorgreen>
      <backgroundcolorblue>112</backgroundcolorblue>
      <bordercolorred>100</bordercolorred>
      <bordercolorgreen>100</bordercolorgreen>
      <bordercolorblue>100</bordercolorblue>
      <drawshadow>Y</drawshadow>
    </notepad>
  </notepads>
  <order>
    <hop>
      <from>Get currency rates</from>
      <to>Calculate date for rate</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Calculate date for rate</from>
      <to>Remove braces</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Remove braces</from>
      <to>Iterate over currencies</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Iterate over currencies</from>
      <to>Split fields</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Split fields</from>
      <to>Remove quotes</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Remove quotes</from>
      <to>Select columns</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Select columns</from>
      <to>Insert / update</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <transform>
    <name>Get currency rates</name>
    <type>JsonInput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <include>N</include>
    <include_field/>
    <rownum>N</rownum>
    <addresultfile>N</addresultfile>
    <readurl>N</readurl>
    <removeSourceField>N</removeSourceField>
    <IsIgnoreEmptyFile>N</IsIgnoreEmptyFile>
    <doNotFailIfNoFile>Y</doNotFailIfNoFile>
    <ignoreMissingPath>Y</ignoreMissingPath>
    <defaultPathLeafToNull>Y</defaultPathLeafToNull>
    <rownum_field/>
    <file>
      <name>/home/rolf/DataWorkbench/OpenExchangeRates/2014</name>
      <filemask>.+\.json</filemask>
      <exclude_filemask/>
      <file_required>N</file_required>
      <include_subfolders>N</include_subfolders>
      <name>/home/rolf/DataWorkbench/OpenExchangeRates/2018</name>
      <filemask>2018-12-.+\.json</filemask>
      <exclude_filemask/>
      <file_required>N</file_required>
      <include_subfolders>N</include_subfolders>
    </file>
    <fields>
      <field>
        <name>rates</name>
        <path>$.rates</path>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>both</trim_type>
        <repeat>N</repeat>
      </field>
      <field>
        <name>timestamp</name>
        <path>$.timestamp</path>
        <type>Integer</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
        <repeat>N</repeat>
      </field>
      <field>
        <name>base_currency</name>
        <path>$.base</path>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
        <repeat>N</repeat>
      </field>
    </fields>
    <limit>0</limit>
    <IsInFields>N</IsInFields>
    <IsAFile>N</IsAFile>
    <valueField/>
    <shortFileFieldName/>
    <pathFieldName/>
    <hiddenFieldName/>
    <lastModificationTimeFieldName/>
    <uriNameFieldName/>
    <rootUriNameFieldName/>
    <extensionFieldName/>
    <sizeFieldName/>
    <attributes/>
    <cluster_schema/>
    <GUI>
      <xloc>384</xloc>
      <yloc>96</yloc>
      <draw>Y</draw>
    </GUI>
  </transform>
  <transform>
    <name>Calculate date for rate</name>
    <type>ScriptValueMod</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <compatible>N</compatible>
    <optimizationLevel>9</optimizationLevel>
    <jsScripts>
      <jsScript>
        <jsScript_type>0</jsScript_type>
        <jsScript_name>Script 1</jsScript_name>
        <jsScript_script>//Script here

var date = date2str(new Date((timestamp - 24*60*60)*1000), "YYYY-MM-dd")
</jsScript_script>
      </jsScript>
      <jsScript>
        <jsScript_type>-1</jsScript_type>
        <jsScript_name>date2str_Sample</jsScript_name>
        <jsScript_script>// Converts the given Date to a string Value.
//
// Usage:
// date2str(var);
// 1: Date - The Variable with the Date to convert.
// This call uses your localized format.
//
// date2str(var, var);
// 1: Date - The Variable with the Date to convert.
// 2: String - The Format:
//        yy / yyyy - 06 / 2006
//        MM / MMM / MMMMM - 11 / Nov / November
//        d / dd  - 1 / 01
//        E / EEEE - Tue / Tuesday
//        hh / HH - 11 / 23
//        m / mm - 5 / 05
//        s / ss - 8 / 08
//
// date2str(var, var, var);
// 1: Date - The Variable with the Date to convert.
// 2: String - The Format:
// 3: String - The Locale Parameter
//    A valid ISO Language Code. (DE = German, EN = English, FR = France, ...)
//
// date2str(var, var, var, var);
// 1: Date - The Variable with the Date to convert.
// 2: String - The Format:
// 3: String - The Locale Parameter
//    A valid ISO Language Code. (DE = German, EN = English, FR = France, ...)
// 4: String - The Timezone Parameter.
//    A valid timezone: EST, GMT, ... (if invalid GMT will be selected as default)
// 
// 2006-11-15
//
var dValue = new Date();
Alert(date2str(dValue));
Alert(date2str(dValue,"dd.MM.yyyy"));
Alert(date2str(dValue,"dd.MM.yyyy HH:mm:ss"));
Alert(date2str(dValue,"E.MMM.yyyy","DE"));
Alert(date2str(dValue,"dd.MM.yyyy HH:mm:ss","EN"));
Alert(date2str(dValue,"dd.MM.yyyy HH:mm:ss","EN", "EST"));
     </jsScript_script>
      </jsScript>
    </jsScripts>
    <fields>
      <field>
        <name>date</name>
        <rename>date</rename>
        <type>String</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <GUI>
      <xloc>576</xloc>
      <yloc>96</yloc>
      <draw>Y</draw>
    </GUI>
  </transform>
  <transform>
    <name>Iterate over currencies</name>
    <type>SplitFieldToRows3</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <splitfield>rates_list</splitfield>
    <delimiter>,</delimiter>
    <newfield>rate_line</newfield>
    <rownum>N</rownum>
    <rownum_field/>
    <resetrownumber>Y</resetrownumber>
    <delimiter_is_regex>N</delimiter_is_regex>
    <attributes/>
    <cluster_schema/>
    <GUI>
      <xloc>928</xloc>
      <yloc>96</yloc>
      <draw>Y</draw>
    </GUI>
  </transform>
  <transform>
    <name>Select columns</name>
    <type>SelectValues</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <name>base_currency</name>
        <rename/>
      </field>
      <field>
        <name>date</name>
        <rename/>
      </field>
      <field>
        <name>rate</name>
        <rename/>
      </field>
      <field>
        <name>target_currency</name>
        <rename/>
      </field>
      <select_unspecified>N</select_unspecified>
    </fields>
    <attributes/>
    <cluster_schema/>
    <GUI>
      <xloc>768</xloc>
      <yloc>224</yloc>
      <draw>Y</draw>
    </GUI>
  </transform>
  <transform>
    <name>Remove braces</name>
    <type>ReplaceString</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <in_stream_name>rates</in_stream_name>
        <out_stream_name>rates_list</out_stream_name>
        <use_regex>yes</use_regex>
        <replace_string>^\{(.*)\}$</replace_string>
        <replace_by_string>$1</replace_by_string>
        <set_empty_string>N</set_empty_string>
        <replace_field_by_string/>
        <whole_word>no</whole_word>
        <case_sensitive>no</case_sensitive>
        <is_unicode>no</is_unicode>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <GUI>
      <xloc>768</xloc>
      <yloc>96</yloc>
      <draw>Y</draw>
    </GUI>
  </transform>
  <transform>
    <name>Split fields</name>
    <type>FieldSplitter</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <splitfield>rate_line</splitfield>
    <delimiter>:</delimiter>
    <enclosure/>
    <fields>
      <field>
        <name>raw_currency</name>
        <id/>
        <idrem>N</idrem>
        <type>String</type>
        <format/>
        <group/>
        <decimal/>
        <currency/>
        <length>-1</length>
        <precision>-1</precision>
        <nullif/>
        <ifnull/>
        <trimtype>none</trimtype>
      </field>
      <field>
        <name>rate</name>
        <id/>
        <idrem>N</idrem>
        <type>Number</type>
        <format/>
        <group/>
        <decimal/>
        <currency/>
        <length>-1</length>
        <precision>-1</precision>
        <nullif/>
        <ifnull/>
        <trimtype>none</trimtype>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <GUI>
      <xloc>1120</xloc>
      <yloc>96</yloc>
      <draw>Y</draw>
    </GUI>
  </transform>
  <transform>
    <name>Remove quotes</name>
    <type>ReplaceString</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <in_stream_name>raw_currency</in_stream_name>
        <out_stream_name>target_currency</out_stream_name>
        <use_regex>yes</use_regex>
        <replace_string>"(.*)"</replace_string>
        <replace_by_string>$1</replace_by_string>
        <set_empty_string>N</set_empty_string>
        <replace_field_by_string/>
        <whole_word>no</whole_word>
        <case_sensitive>no</case_sensitive>
        <is_unicode>no</is_unicode>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <GUI>
      <xloc>1328</xloc>
      <yloc>96</yloc>
      <draw>Y</draw>
    </GUI>
  </transform>
  <transform>
    <name>Insert / update</name>
    <type>InsertUpdate</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>dataworkbench</connection>
    <commit>100</commit>
    <update_bypassed>N</update_bypassed>
    <lookup>
      <schema>dra</schema>
      <table>dim_currency_rates</table>
      <key>
        <name>base_currency</name>
        <field>base_currency</field>
        <condition>=</condition>
        <name2/>
      </key>
      <key>
        <name>date</name>
        <field>date</field>
        <condition>=</condition>
        <name2/>
      </key>
      <key>
        <name>target_currency</name>
        <field>target_currency</field>
        <condition>=</condition>
        <name2/>
      </key>
      <value>
        <name>base_currency</name>
        <rename>base_currency</rename>
        <update>Y</update>
      </value>
      <value>
        <name>date</name>
        <rename>date</rename>
        <update>Y</update>
      </value>
      <value>
        <name>rate</name>
        <rename>rate</rename>
        <update>Y</update>
      </value>
      <value>
        <name>target_currency</name>
        <rename>target_currency</rename>
        <update>Y</update>
      </value>
    </lookup>
    <attributes/>
    <cluster_schema/>
    <GUI>
      <xloc>1024</xloc>
      <yloc>224</yloc>
      <draw>Y</draw>
    </GUI>
  </transform>
  <transform_error_handling>
  </transform_error_handling>
  <attributes/>
</pipeline>
